=title How to run the tests of a typical Perl module
=timestamp 2018-04-17T11:45:56
=indexes Build.PL, Makefile.PL, dist.ini, make, prove
=status show
=author szabgab
=comments_disqus_enable 1

=abstract start

If you'd like to contribute code to a Perl based project - typically a CPAN module - the
first thing you need to make sure is that all the tests of the current version work well on your computer.

If you don't do this and after you make some changes you find out that something is not working you won't
know if your changes broke that part of the project, or if it was already broken.

=abstract end

<h2>Where are the unit tests of the Perl module?</h2>

Almost all the Perl modules on CPAN have a <hl>t/</hl> directory and in that directory there are files
with <hl>.t</hl> extension. These files are the tests of the typical Perl project.

In some cases you will find more tests in the subdirectories of <hl>t/</hl>.

In some cases there is an additional directory called <hl>xt/</hl> with additional test that
should be run by the developers and contributors only.

In other cases, especially in older modules, you'll find a file called <hl>test.pl</hl> in the root
directory of the distribution.

<h2>The normal workflow of the Perl module development</h2>

There are 4 major packaging systems for Perl. The ones using
<a href="https://metacpan.org/pod/Module::Build">Module::Build</a> will have a file called <hl>Build.PL</hl>.
In this case the workflow to run the tests is

<code>
perl Build.PL
perl Build
perl Build test
</code>

<a href="https://metacpan.org/pod/ExtUtils::MakeMaker">ExtUtils::MakeMaker</a>
and <a href="https://metacpan.org/pod/Module::Install">Module::Install</a> both use a file
called Makefile.PL

In this case the flow is:

<code>
perl Makefile.PL
make
make test
</code>

(On MS Windows, it is probably nmake or dmake instead of make.)

<a href="http://dzil.org/">Dist::Zilla</a> can be recognized by the dist.ini file in the root directory.
It needs less ceremony, you only need to type

<code>
dzil test
</code>

well, of course after you've installed <a href="https://metacpan.org/pod/Dist::Zilla">Dist::Zilla</a> and all the other dependencies.

<h2>More than one packaging system</h2>

Normally only one of the 3 files: <hl>Build.PL</hl>, <hl>Makefile.PL</hl>, or <hl>dist.ini</hl> should be
in the source code repository of every CPAN distribution BUT:

When releasing a distribution Dist::Zilla will create a <hl>Makefile.PL</hl> file. Some developers add this file
to their version control system to make it easier to contribute to their code, even though they probably <a href="/dont-keep-generated-files-in-version-control">should not</a> as it is a generated file.

On one hand the argument is that you should never include any file in your source repository that can be generated from the other files of your repository, on the other hand having the already generated Makefile.PL will make it a lot easier for someone to contribute without installing the whole Dist::Zilla toolchain. While the latter approach is more pragmatic and easier for the drive-by contributors, there is a risk that the two files diverge. Either by someone mistakenly editing the Makefile.PL or by not updating the Makefile.PL after the dzil.ini file was updated.

Build.PL can generate a Makefile.PL during the release process. Because for a long time Build.PL could not handle itself alone,
many CPAN developers have opted to include this Makefile.PL in the distribution. Unfortunately some of them
have also added these to their version control system, even though they probably <a href="/dont-keep-generated-files-in-version-control">should not</a>.

So if you see both <hl>Build.PL</hl> and <hl>Makefile.PL</hl> then it is probably Build.PL that is the source. The best would be
to talk to the author and to either remove Makefile.PL from the version control, or to switch the whole distribution
to use either Dist::Zilla or one of the Makefile.PL based tools and remove Build.PL from the repository.
Short of doing that, you can look into the Makefile.PL. If it has a comment like this:

<code>
# Note: this file was auto-generated by Module::Build::Compat version ...
</code>

then you can be quite sure it was indeed generated from the Build.PL file.

<h2>Install dependencies</h2>

Normally the Build.PL, the Makefile.PL, or the dist.ini file will have a list of all the modules that are
required for the module under investigation, to run. Sometime they also have separate section for build-time
and/or test-time dependencies. For example many modules will require all kinds of Test::* modules in order to
be tested, but they won't need those modules for actually running the code.

Some modules have optional run-time dependencies and some have optional test-time dependencies.
The former are usually described in the documentation. An example for that might be a module such as 
<a href="https://metacpan.org/pod/Text::CSV">Text::CSV</a> that would work by itself, but
if you also have <a href="https://metacpan.org/pod/Text::CSV_XS">Text::CSV_XS</a> installed then
it will use that and be a lot faster.

Other example might be a module that can work with multiple database backend. It might have none
of the database engines required by default, but you'd only be able to use it with any database
if the driver for that specific database is installed. Separately.
<a href="https://metacpan.org/pod/DBI">DBI</a> the Database independent interface for Perl works that way.

As of optional test-time dependencies. The most common such modules are the ones that test if the code
adheres to the <a href="https://metacpan.org/pod/Perl::Critic">Perl::Critic</a> rules specified by the authors.

<h2>Running tests with prove</h2>

Using the <hl>prove</hl> command it is easy to run tests both in the <hl>t/</hl> and in the <hl>xt/</hl> directories:

<code>
$ perl Makefile.PL
$ make

$ prove -b t/ xt/
</code>

<h2>No skipped test</h2>

When you run the test, especially when you also include the <hl>xt/</hl> directory you might see
that some of the test files, or some tests in specific files are being skipped.

You'll need to check why are they skipped. Some might be always skipped because the tests are broken
and the author of the module has decided to temporarily disable the tests.
Most of the skipped tests however are skipped because of a missing optional dependency or because they
are not relevant to your environment. (e.g. There might be MS Windows-specific tests that will never
run on your Linux.) If they are skipped due to a missing dependency, or a lack of some configuration
parameter, then install those dependencies and set those configurations so as many of the tests as possible
will run on your.

After all they are there to protect you from introducing a bug while making your improvements.

<h2>TODO</h2>

Once you managed to run all the test and you saw that all of them are passing in your environment
you can start making your changes.

